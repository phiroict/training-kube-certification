---
resources:
- name: gateway-project
  type: git
  source:
    uri: https://github.com/phiroict/training-kube-certification
    branch: main
- name: rust-builder
  type: registry-image
  source:
    repository: rust
    tag: latest
- name: build-container-repo
  type: registry-image
  icon: docker
  source:
    repository: phiroict/training_k8s_rust_gateway
    tag: 20220813
    username: ((registry-username.registry-username))
    password: ((registry-password.registry-password))

jobs:
- name: build-ms-gateway
  plan:
  - get: gateway-project
    trigger: true
  - get: rust-builder
    trigger: true
#  - task: run-build
#    image: rust-builder
#    config:
#      inputs:
#      - name: gateway-project
#      outputs:
#      - name: executable
#        path: gateway-project/apps/gateway/target/release/gateway
#      platform: linux
#      run:
#        dir: gateway-project/apps/gateway
#        path: cargo
#        args: ["build", "--release"]
  - task: build-task-image
    privileged: true
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: vito/oci-build-task
      inputs:
      - name: gateway-project
      outputs:
      - name: image
      run:
        path: build
      params:
        DOCKERFILE: gateway-project/infra/docker/Dockerfile
        CONTEXT: gateway-project
        BUILD_ARG_app_name: gateway
        BUILD_ARG_path: apps
  - put: build-container-repo
    params:
      image: image/image.tar